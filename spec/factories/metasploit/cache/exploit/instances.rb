FactoryGirl.define do
  factory :metasploit_cache_exploit_instance,
          class: Metasploit::Cache::Exploit::Instance,
          traits: [
              :metasploit_cache_contributable_contributions,
              :metasploit_cache_licensable_licensable_licenses
          ] do
    transient do
      exploit_target_count 1
      referencable_reference_count 1
    end

    description { generate :metasploit_cache_exploit_instance_description }
    disclosed_on { generate :metasploit_cache_exploit_instance_disclosed_on }
    name { generate :metasploit_cache_exploit_instance_name }
    privileged { generate :metasploit_cache_exploit_instance_privileged }
    stance { generate :metasploit_cache_module_stance }

    #
    # Associations
    #

    association :exploit_class, factory: :metasploit_cache_exploit_class

    #
    # Callbacks
    #

    after(:build) { |exploit_instance, evaluator|
      exploit_instance.exploit_targets = build_list(
          :metasploit_cache_exploit_target,
          evaluator.exploit_target_count,
          exploit_instance: exploit_instance
      )

      exploit_instance.referencable_references = build_list(
        :metasploit_cache_exploit_reference,
        evaluator.referencable_reference_count,
        referencable: exploit_instance
      )
    }
  end

  #
  # Sequences
  #

  sequence :metasploit_cache_exploit_instance_description do |n|
    "Metasploit::Cache::Exploit::Instance#description #{n}"
  end

  sequence :metasploit_cache_exploit_instance_disclosed_on do |n|
    n.days.ago
  end

  sequence :metasploit_cache_exploit_instance_name do |n|
    "Metapsloit::Cache::Exploit::Instance#name #{n}"
  end

  sequence :metasploit_cache_exploit_instance_privileged, Metasploit::Cache::Spec.sample_stream([false, true])
end